<!DOCTYPE html>
<html lang="en">

<!-- Head -->
<th:block th:replace="~{/includes/admin/head}" />

<body id="page-top">

<!-- =================== Templates =================== -->
<script id="list_info_permissiondetail" type="text/x-handlebars-template">
    {{#resultData_permissiondetail}}
    <tr class="gradeA">
        <td>{{title}}</td>
        <td><input class="input_chk_all input_chk_all_{{target}}" type="checkbox" id="input_chk_each_{{target}}_0" onchange="listener_chk_permission('{{target}}','0')" /></td>
        <td><input class="input_chk_each input_chk_each_{{target}}" type="checkbox" id="input_chk_each_{{target}}_110" onchange="listener_chk_permission('{{target}}','110')" /></td>
        <td><input class="input_chk_each input_chk_each_{{target}}" type="checkbox" id="input_chk_each_{{target}}_120" onchange="listener_chk_permission('{{target}}','120')" /></td>
        <td><input class="input_chk_each input_chk_each_{{target}}" type="checkbox" id="input_chk_each_{{target}}_200" onchange="listener_chk_permission('{{target}}','200')" /></td>
    </tr>
    {{/resultData_permissiondetail}}
</script>

<script id="list_info_permissionuser" type="text/x-handlebars-template">
    {{#resultData_permissionuser}}
    <tr class="gradeA" id="tr_permissionuser_{{id}}">
        <td><font class="font_permissionuser_order">-</font></td>
        <td>{{userUsername}}</td>
        <td><button class="btn btn-danger btn-sm" onclick="delete_permissionuser('{{id}}')">삭제</button></td>
    </tr>
    {{/resultData_permissionuser}}
</script>

<!-- Page Wrapper -->
<div id="wrapper">
    <th:block th:replace="~{/includes/admin/sidebar}" />
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <th:block th:replace="~{/includes/admin/topper}" />
            <div class="container-fluid">
                <h1 class="h3 mb-2 text-gray-800">Role Detail</h1>
                <p class="mb-4">Role Detail example</p>

                <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Name</label>
                    <div class="col-sm-6">
                        <input type="text" class="input_param input_required form-control" id="role_name" name="title" readonly />
                    </div>
                </div>

                <div class="form-group row">
                    <label class="col-sm-2 col-form-label">Content</label>
                    <div class="col-sm-6">
                        <textarea class="input_param form-control" id="role_content" name="content" readonly></textarea>
                    </div>
                </div>

                <div class="form-group row mt-6">
                    <div class="col-sm-8 offset-sm-8 text-end">
                        <button class="btn btn-info m-1" id="detail_role_btn" onclick="detail_role()">Load</button>
                        <a class="btn btn-primary m-1" id="update_role_btn" href="/admin/role/update">Update</a>
                        <button class="btn btn-danger m-1" id="delete_role_btn" onclick="detail_role()">Delete</button>
                    </div>
                </div>

                <ul class="nav nav-tabs">
                    <li><a class="nav-link active" data-toggle="tab" href="#tab-part">권한 상세</a></li>
                    <li><a class="nav-link" data-toggle="tab" href="#tab-user" onclick="search_permissionuser();">권한 사용자</a></li>
                </ul>

                <div class="tab-content bg-white">
                    <div id="tab-part" class="tab-pane active">
                        <table class="table table-bordered">
                            <thead><tr><th>권한상세</th><th>전체</th><th>입력</th><th>수정</th><th>조회</th></tr></thead>
                            <tbody id="tbody_permissiondetail_list"></tbody>
                        </table>
                    </div>
                    <div id="tab-user" class="tab-pane">
                        <div class="text-right">
                            <button type="button" class="btn btn-primary btn-sm m-2" data-toggle="modal" data-target="#createPermissionuser">추가하기</button>
                        </div>
                        <table class="table table-bordered">
                            <thead><tr><th>#</th><th>사용자ID</th><th>/</th></tr></thead>
                            <tbody id="tbody_permissionuser_list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <th:block th:replace="~{/includes/admin/footer}" />
    </div>
</div>

<a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>
<th:block th:replace="~{/includes/admin/logout}" />
<th:block th:replace="~{/includes/admin/script}" />

<script>
    const list_info_permissiondetail_template = Handlebars.compile($("#list_info_permissiondetail").html());
    const list_info_permissionuser_template = Handlebars.compile($("#list_info_permissionuser").html());

    let role_id = window.location.pathname.split("/").pop();

    function toggle_permissiondetail(obj_alive, obj_target, obj_func) {
        let _param = {
            'permissionId': getIdFromUrl(null),
            'alive': obj_alive,
            'target': obj_target,
            'func': obj_func
        };
        let _data = {
            url: "/api/permissiondetail/toggle",
            type: "POST",
            param: _param,
            success: function () { listener_chk_permission_all(obj_target); },
            error: function () { alert("정상적으로 이루어지지 않았습니다. 다시 시도해주세요."); }
        };
        func_ajax(_data);
    }

    function listener_chk_permission(obj_target, obj_func) {
        let checked = $("#input_chk_each_" + obj_target + "_" + obj_func).prop("checked");
        if (obj_func === '0') {
            let tempArray = [110, 120, 200];
            for (let each of tempArray) {
                $("#input_chk_each_" + obj_target + "_" + each).prop("checked", checked);
                toggle_permissiondetail(checked, obj_target, each);
            }
        } else {
            toggle_permissiondetail(checked, obj_target, obj_func);
        }
    }

    function listener_chk_permission_all(obj_target) {
        let isOn = true;
        let input_chk_each = $(".input_chk_each_" + obj_target);
        for (let each of input_chk_each) {
            if (!$(each).prop("checked")) {
                isOn = false;
                break;
            }
        }
        $("#input_chk_each_" + obj_target + "_0").prop("checked", isOn);
    }

    function detail_role() {
        let permissionId = Number(role_id);
        let _data = {
            url: "/api/role/detail",
            type: "GET",
            param: { 'id': permissionId },
            success: function (obj_data) {
                $("#update_role_btn").attr("href", "/admin/role/update/" + role_id);
                $("#role_name").val(obj_data["roleName"]);
                $("#role_content").val(obj_data["content"]);
                $("#tbody_permissiondetail_list").html("");

                let targets = obj_data["permissions"];
                for (let each of targets) {
                    let eachData = {
                        target: each[0],
                        title: each[1]
                    };
                    $("#tbody_permissiondetail_list").append(
                        list_info_permissiondetail_template({ "resultData_permissiondetail": [eachData] })
                    );
                }

                let details = obj_data["permissionList"];
                for (let each of details) {
                    $("#input_chk_each_" + each["target"] + "_" + each["func"]).prop("checked", true);
                    listener_chk_permission_all(each["target"]);
                }
            },
            error: function () {
                alert("정상적으로 이루어지지 않았습니다. 다시 시도해주세요.");
            }
        };
        func_ajax(_data);
    }
</script>

</body>
</html>
